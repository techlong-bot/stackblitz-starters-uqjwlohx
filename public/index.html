<!DOCTYPE html>
<html>
<head>
    <title>Titan Ultra Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
        }

        h1 { text-align: center; margin: 10px 0 20px 0; color: #58a6ff; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }

        /* GRID LAYOUT */
        .grid-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        @media (max-width: 1200px) { .grid-container { grid-template-columns: 1fr; } }

        .panel {
            background-color: #161b22;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .panel-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- AI & WALLET HEADER --- */
        .top-grid {
            display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px;
            max-width: 1800px; margin: 0 auto 20px auto;
        }
        @media (max-width: 1000px) { .top-grid { grid-template-columns: 1fr; } }

        .ai-box {
            background: #161b22; padding: 15px; border-radius: 10px; border: 1px solid #30363d;
            display: flex; align-items: center; gap: 15px;
        }
        .wallet-box {
            background: #161b22; padding: 15px; border-radius: 10px; border: 1px solid #30363d;
            display: flex; flex-direction: column; justify-content: center;
        }
        .balance-val { font-size: 24px; font-weight: bold; color: #e6edf3; }
        .pnl-val { font-size: 14px; font-weight: bold; }
        .green { color: #2ea043; } .red { color: #ff7b72; }

        /* --- CONTROLS --- */
        .controls { display: flex; gap: 10px; }
        button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; transition: all 0.2s; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-gray { background: #30363d; color: white; }
        .btn-blue { background: #58a6ff; color: black; }
        .btn-purple { background: #a371f7; color: white; box-shadow: 0 0 10px rgba(163, 113, 247, 0.3); }

        /* --- TABLE --- */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 10px; color: #8b949e; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #30363d; }
        th:first-child { text-align: left; }
        tr:not(:first-child) { transition: background 0.1s; }
        tr:hover:not(:first-child) { background-color: #21262d; }
        td { padding: 12px 10px; border-bottom: 1px solid #21262d; vertical-align: middle; font-size: 13px; text-align: right; }
        td:first-child { text-align: left; }
        
        .coin-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        /* TRADING BUTTONS */
        .trade-btn { padding: 4px 8px; font-size: 11px; margin-left: 5px; }
        .btn-buy { background: #2ea043; color: white; }
        .btn-sell { background: #ff7b72; color: white; }

        /* NEWS TICKER */
        .news-ticker {
            background: #090c10; border-bottom: 1px solid #30363d; color: #8b949e;
            font-size: 12px; white-space: nowrap; overflow: hidden; padding: 8px 0; margin-bottom: 20px;
        }
        .ticker-content { display: inline-block; animation: scroll 60s linear infinite; padding-left: 100%; }
        .news-item { margin-right: 40px; color: #c9d1d9; cursor: pointer; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { width: 400px; background: #161b22; padding: 20px; border-radius: 10px; border: 1px solid #30363d; text-align: center; }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 5px; }
        
        /* WHALE FEED */
        #whaleFeed { height: 600px; overflow-y: auto; font-family: monospace; }
        .feed-item { padding: 8px; border-bottom: 1px solid #21262d; font-size: 12px; display: flex; justify-content: space-between; animation: fadeIn 0.3s; }
        .feed-buy { border-left: 3px solid #2ea043; background: rgba(46, 160, 67, 0.05); }
        .feed-sell { border-left: 3px solid #ff7b72; background: rgba(255, 123, 114, 0.05); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <h1>‚ö° Titan Ultra Terminal</h1>

    <div class="news-ticker">
        <div id="tickerContent" class="ticker-content">Loading live crypto news...</div>
    </div>

    <div class="top-grid">
        <div class="ai-box">
            <div style="font-size:30px">ü§ñ</div>
            <div>
                <div style="font-size:10px; color:#8b949e; margin-bottom:5px">MARKET NARRATOR</div>
                <div id="aiText" style="font-family:monospace; font-size:13px; color:#7ee787;">Initializing...</div>
            </div>
        </div>
        <div class="wallet-box">
            <div style="font-size:12px; color:#8b949e;">PAPER WALLET</div>
            <div class="balance-val" id="walletBalance">$10,000</div>
            <div style="font-size:11px; color:#8b949e">Cash Available</div>
        </div>
        <div class="wallet-box">
            <div style="font-size:12px; color:#8b949e;">TOTAL PNL</div>
            <div class="balance-val" id="totalPnl">$0.00</div>
            <div class="pnl-val" id="pnlPercent">0.00%</div>
        </div>
    </div>

    <div class="grid-container">
        
        <div class="panel">
            <div class="panel-header">
                <span id="listTitle">Market Data</span>
                <div class="controls">
                    <button class="btn-blue" onclick="switchMode('TOP')">Top 25</button>
                    <button class="btn-purple" onclick="switchMode('GEM')">üíé Gem Hunter</button>
                    <button class="btn-gray" onclick="togglePortfolio()">üíº My Trades</button>
                </div>
            </div>
            
            <table id="cryptoTable">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Price</th>
                        <th>RSI</th>
                        <th>24h %</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center; padding:20px">Loading System...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="panel">
            <div class="panel-header">
                <span>üö® Whale Radar</span>
                <span style="font-size:12px; color: #2ea043">‚óè Live</span>
            </div>
            <div id="whaleFeed">
                <div style="text-align:center; padding:20px; color:#8b949e">Connecting...</div>
            </div>
        </div>
    </div>

    <div id="tradeModal" class="modal">
        <div class="modal-box">
            <h2 id="modalTitle">Buy BTC</h2>
            <p id="modalPrice">Price: $50,000</p>
            <input type="number" id="tradeAmount" class="modal-input" placeholder="Amount in USD (e.g. 500)">
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                <button class="btn-gray" onclick="closeTradeModal()">Cancel</button>
                <button class="btn-buy" id="confirmTradeBtn">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="chartModal" class="modal">
        <div class="modal-box" style="width:90%; height:80%;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="chartTitle" style="font-weight:bold">CHART</span>
                <span style="cursor:pointer; color:#ff7b72;" onclick="document.getElementById('chartModal').style.display='none'">√ó CLOSE</span>
            </div>
            <div id="chartContainer" style="height:100%"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const WHALE_THRESHOLD = 50000;
        const IGNORED_COINS = ['usdt', 'usdc', 'dai'];
        
        // STATE
        let marketData = [];
        let socket = null;
        let mode = 'TOP'; // 'TOP' or 'GEM'
        let showPortfolio = false;
        
        // WALLET STATE
        let wallet = JSON.parse(localStorage.getItem('titanWallet')) || {
            cash: 10000,
            holdings: {} // { "BTC": { amount: 0.5, avgPrice: 30000 } }
        };

        // --- 1. INITIALIZATION ---
        async function initApp() {
            fetchNews();
            updateWalletUI();
            
            try {
                let coins = [];
                
                if (mode === 'TOP') {
                    // Fetch Top 25
                    document.getElementById('listTitle').innerText = "Top 25 Market Cap";
                    const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=25&page=1&sparkline=true');
                    coins = await res.json();
                } else {
                    // GEM HUNTER MODE
                    document.getElementById('listTitle').innerText = "üíé Trending Viral Coins";
                    // 1. Get Trending IDs
                    const trendRes = await fetch('https://api.coingecko.com/api/v3/search/trending');
                    const trendData = await trendRes.json();
                    const ids = trendData.coins.map(c => c.item.id).join(',');
                    
                    // 2. Get Full Data for IDs
                    const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&sparkline=true`);
                    coins = await res.json();
                }

                updateAINarrator(coins);

                marketData = coins.map(coin => {
                    const rsi = calcRSI(coin.sparkline_in_7d ? coin.sparkline_in_7d.price : []);
                    return {
                        id: coin.id,
                        symbol: coin.symbol.toUpperCase(),
                        rawSymbol: coin.symbol.toLowerCase(),
                        image: coin.image,
                        price: coin.current_price,
                        change: coin.price_change_percentage_24h,
                        rsi: rsi
                    };
                });

                renderTable();
                startWhaleSocket(marketData);

            } catch (e) { console.log(e); setTimeout(initApp, 10000); }
        }

        function switchMode(newMode) {
            mode = newMode;
            showPortfolio = false;
            initApp();
        }

        function togglePortfolio() {
            showPortfolio = !showPortfolio;
            renderTable();
        }

        // --- 2. MATH ---
        function calcRSI(prices) {
            if(!prices || prices.length < 15) return 50;
            let gains=0, losses=0;
            for(let i=1; i<15; i++) {
                let diff = prices[i] - prices[i-1];
                if(diff>=0) gains+=diff; else losses+=Math.abs(diff);
            }
            if(losses===0) return 100;
            return 100 - (100/(1+(gains/losses)));
        }

        // --- 3. UI RENDER ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            
            // Filter if showing portfolio
            let displayData = marketData;
            if (showPortfolio) {
                document.getElementById('listTitle').innerText = "üíº My Holdings";
                displayData = marketData.filter(c => wallet.holdings[c.symbol]);
                if (displayData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px">No active trades. Go buy something!</td></tr>`;
                    return;
                }
            }

            displayData.forEach(coin => {
                let holding = wallet.holdings[coin.symbol];
                let rowColor = "";
                
                // Show profit/loss if holding
                if(holding) {
                    let pnl = (coin.price - holding.avgPrice) / holding.avgPrice * 100;
                    rowColor = pnl >= 0 ? "rgba(46, 160, 67, 0.1)" : "rgba(255, 123, 114, 0.1)";
                }

                const row = document.createElement('tr');
                row.style.background = rowColor;
                row.innerHTML = `
                    <td onclick="openChart('${coin.symbol}')">
                        <div class="coin-info">
                            <img src="${coin.image}" style="width:24px; border-radius:50%">
                            <div>
                                <b>${coin.symbol}</b>
                                ${holding ? `<div style="font-size:10px; color:#8b949e">${holding.amount.toFixed(4)} coins</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>$${coin.price.toLocaleString()}</td>
                    <td style="color:${coin.rsi>70?'#ff7b72':coin.rsi<30?'#2ea043':'#8b949e'}">${coin.rsi.toFixed(0)}</td>
                    <td style="color:${coin.change>=0?'#2ea043':'#ff7b72'}">${coin.change.toFixed(2)}%</td>
                    <td>
                        <button class="trade-btn btn-buy" onclick="openTrade('BUY', '${coin.symbol}', ${coin.price})">BUY</button>
                        <button class="trade-btn btn-sell" onclick="openTrade('SELL', '${coin.symbol}', ${coin.price})">SELL</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- 4. TRADING LOGIC ---
        let currentTrade = {};

        function openTrade(type, symbol, price) {
            currentTrade = { type, symbol, price };
            document.getElementById('tradeModal').style.display = 'flex';
            document.getElementById('modalTitle').innerText = `${type} ${symbol}`;
            document.getElementById('modalPrice').innerText = `Current Price: $${price}`;
            
            const btn = document.getElementById('confirmTradeBtn');
            btn.className = type === 'BUY' ? 'btn-buy' : 'btn-sell';
            btn.onclick = executeTrade;
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').style.display = 'none';
            document.getElementById('tradeAmount').value = '';
        }

        function executeTrade() {
            const usdAmount = parseFloat(document.getElementById('tradeAmount').value);
            if (!usdAmount || usdAmount <= 0) return alert("Invalid amount");
            
            const { type, symbol, price } = currentTrade;
            
            if (type === 'BUY') {
                if (wallet.cash < usdAmount) return alert("Not enough cash!");
                const coinAmount = usdAmount / price;
                
                // Update Holdings
                if (!wallet.holdings[symbol]) wallet.holdings[symbol] = { amount: 0, avgPrice: 0 };
                let h = wallet.holdings[symbol];
                
                // Calculate new avg price
                let totalCost = (h.amount * h.avgPrice) + usdAmount;
                h.amount += coinAmount;
                h.avgPrice = totalCost / h.amount;
                
                wallet.cash -= usdAmount;
            } 
            else if (type === 'SELL') {
                if (!wallet.holdings[symbol]) return alert("You don't own this coin!");
                const coinAmount = usdAmount / price;
                if (wallet.holdings[symbol].amount < coinAmount) return alert("Not enough coins!");
                
                wallet.holdings[symbol].amount -= coinAmount;
                wallet.cash += usdAmount;
                
                if (wallet.holdings[symbol].amount <= 0.0001) delete wallet.holdings[symbol];
            }

            // Save and Update
            localStorage.setItem('titanWallet', JSON.stringify(wallet));
            updateWalletUI();
            closeTradeModal();
            renderTable();
        }

        function updateWalletUI() {
            document.getElementById('walletBalance').innerText = `$${wallet.cash.toLocaleString(undefined, {maximumFractionDigits:0})}`;
            
            // Calculate Total PnL
            let totalPortfolioValue = 0;
            // We need current prices to calculate PnL accurately. 
            // This is an estimation based on last fetched prices in marketData
            marketData.forEach(c => {
                if (wallet.holdings[c.symbol]) {
                    totalPortfolioValue += wallet.holdings[c.symbol].amount * c.price;
                }
            });

            let totalEquity = wallet.cash + totalPortfolioValue;
            let startAmount = 10000;
            let pnl = totalEquity - startAmount;
            let pnlPercent = (pnl / startAmount) * 100;

            const pnlEl = document.getElementById('totalPnl');
            pnlEl.innerText = `${pnl>=0?'+':''}$${pnl.toLocaleString(undefined, {maximumFractionDigits:0})}`;
            pnlEl.className = pnl >= 0 ? 'balance-val green' : 'balance-val red';
            
            const pctEl = document.getElementById('pnlPercent');
            pctEl.innerText = `${pnlPercent.toFixed(2)}%`;
            pctEl.className = pnl >= 0 ? 'pnl-val green' : 'pnl-val red';
        }

        // --- 5. AI & NEWS ---
        function updateAINarrator(coins) {
            const aiText = document.getElementById('aiText');
            let winners = coins.filter(c => c.price_change_percentage_24h > 5).length;
            let msg = `Market Scan Complete. `;
            
            if (mode === 'GEM') msg += `<b>Gem Hunter Mode Active.</b> High volatility detected. `;
            
            if (wallet.cash < 2000) msg += `You are heavily invested (Low Cash). Watch risk. `;
            else msg += `You have plenty of dry powder ($${Math.floor(wallet.cash/1000)}k). `;

            if (winners > 5) {
                msg += `Market is green. Look for pullbacks on coins with RSI < 40.`;
                aiText.style.color = "#7ee787";
            } else {
                msg += `Market is bleeding. Be patient. Don't catch falling knives.`;
                aiText.style.color = "#ff7b72";
            }
            aiText.innerHTML = msg;
        }

        async function fetchNews() {
            try {
                const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://cointelegraph.com/rss');
                const data = await res.json();
                document.getElementById('tickerContent').innerHTML = data.items.map(i => `<span class="news-item" onclick="window.open('${i.link}')">üî• ${i.title}</span>`).join('');
            } catch(e) {}
        }

        // --- 6. SOCKET & CHARTS ---
        function openChart(symbol) {
            document.getElementById('chartModal').style.display = 'flex';
            document.getElementById('chartTitle').innerText = `${symbol}/USDT`;
            document.getElementById('chartContainer').innerHTML = `
                <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_1&symbol=BINANCE:${symbol}USDT&interval=60&hidesidetoolbar=1&symboledit=1&saveimage=0&toolbarbg=f1f3f6&studies=[]&theme=dark&style=1&timezone=Etc%2FUTC" 
                style="width:100%; height:100%; border:none;"></iframe>`;
        }

        function startWhaleSocket(coins) {
            if (socket) socket.close();
            const streams = coins.filter(c => !IGNORED_COINS.includes(c.rawSymbol)).map(c => `${c.rawSymbol}usdt@trade`).join('/');
            socket = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data).data;
                const totalUsd = parseFloat(data.p) * parseFloat(data.q);
                if (totalUsd > WHALE_THRESHOLD) {
                    const type = data.m ? 'SELL' : 'BUY';
                    const color = type === 'BUY' ? 'feed-buy' : 'feed-sell';
                    const box = document.getElementById('whaleFeed');
                    const item = document.createElement('div');
                    item.className = `feed-item ${color}`;
                    item.innerHTML = `<div><b>${type==='BUY'?'üü¢':'üî¥'} ${data.s.replace('USDT','')}</b></div><div>$${Math.floor(totalUsd).toLocaleString()}</div>`;
                    box.prepend(item);
                    if(box.children.length > 50) box.removeChild(box.lastChild);
                }
            };
        }

        initApp();
        setInterval(initApp, 60000); // Refresh data every min
    </script>
</body>
</html>