<!DOCTYPE html>
<html>
<head>
    <title>Whale Signal Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
        }

        h1 { text-align: center; margin-bottom: 20px; color: #58a6ff; font-size: 24px; }

        .main-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .panel {
            background-color: #161b22;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            flex: 1;
            min-width: 300px;
            border: 1px solid #30363d;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- LEFT PANEL --- */
        .controls { display: flex; gap: 10px; }
        button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-all { background-color: #30363d; color: white; }
        .btn-buy { background-color: #2ea043; color: white; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 10px; color: #8b949e; font-size: 12px; }
        th:first-child { text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #21262d; vertical-align: middle; text-align: right; font-size: 14px; }
        td:first-child { text-align: left; }

        .coin-info { display: flex; align-items: center; gap: 8px; }
        .coin-icon { width: 24px; height: 24px; border-radius: 50%; }
        .signal-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; white-space: nowrap; }

        /* --- RIGHT PANEL --- */
        #whaleFeed {
            height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
        }

        .feed-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #21262d;
            font-size: 13px;
            animation: fadeIn 0.3s ease-in;
        }

        .feed-buy { border-left: 3px solid #2ea043; background: rgba(46, 160, 67, 0.05); }
        .feed-sell { border-left: 3px solid #ff7b72; background: rgba(255, 123, 114, 0.05); }
        
        .whale-amt { font-weight: bold; color: #e6edf3; font-size: 14px; }
        .whale-sub { color: #8b949e; font-size: 11px; margin-top: 4px; }
        .green-text { color: #2ea043; }
        .red-text { color: #ff7b72; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <h1>üêã Whale Signal Terminal</h1>

    <div class="main-layout">
        
        <div class="panel">
            <div class="panel-header">
                <span>Scanner (Top 25)</span>
                <div class="controls">
                    <button class="btn-all" onclick="filterTable('ALL')">All</button>
                    <button class="btn-buy" onclick="filterTable('BUY')">Buys</button>
                </div>
            </div>
            
            <table id="cryptoTable">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Price</th>
                        <th>Signal</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="3" style="text-align:center; padding:20px">Loading top coins...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="panel">
            <div class="panel-header">
                <span>üö® Multi-Asset Whale Feed</span>
                <span style="font-size:12px; color: #2ea043">‚óè Live</span>
            </div>
            <div id="whaleFeed">
                <div style="text-align:center; padding:20px; color:#8b949e">
                    Initializing WebSocket connection for Top 25 assets...
                </div>
            </div>
        </div>

    </div>

    <script>
        // CONFIGURATION
        const WHALE_THRESHOLD = 50000; // Only show trades > $50k
        const IGNORED_COINS = ['usdt', 'usdc', 'dai', 'fdusd', 'tusd', 'steth', 'wbtc']; // Don't track stablecoins/wrappers
        
        let marketData = [];
        let currentFilter = 'ALL';
        let socket = null;

        // 1. Fetch Data First
        async function initApp() {
            try {
                // Get list from CoinGecko
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=25&page=1&sparkline=false');
                if (!response.ok) throw new Error("API Limit");
                const coins = await response.json();

                // Process for Table
                marketData = coins.map(coin => {
                    const priceChange = coin.price_change_percentage_24h;
                    let signal = "NEUTRAL";
                    let signalColor = "gray";

                    if (priceChange < -2.5) { signal = "BUY DIP"; signalColor = "#2ea043"; } 
                    else if (priceChange > 2.5) { signal = "SELL TOP"; signalColor = "#ff7b72"; }

                    return {
                        symbol: coin.symbol.toUpperCase(), // BTC
                        rawSymbol: coin.symbol.toLowerCase(), // btc
                        name: coin.name,
                        price: coin.current_price,
                        change: priceChange,
                        image: coin.image,
                        signal: signal,
                        signalColor: signalColor
                    };
                });

                renderTable();
                
                // Start WebSocket ONLY after we have the list
                startMultiAssetSocket(marketData);

            } catch (error) {
                console.log("Init Error:", error);
                setTimeout(initApp, 60000); // Retry in 1 min if failed
            }
        }

        // 2. Render Left Table
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ""; 
            const filtered = marketData.filter(c => currentFilter === 'BUY' ? c.signal.includes('BUY') : true);
            
            filtered.forEach(coin => {
                const row = `
                    <tr>
                        <td>
                            <div class="coin-info">
                                <img src="${coin.image}" class="coin-icon">
                                <div>
                                    <b>${coin.symbol}</b>
                                    <div style="font-size:11px" class="${coin.change >= 0 ? 'green-text' : 'red-text'}">
                                        ${coin.change.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>$${coin.price.toLocaleString()}</td>
                        <td><span class="signal-badge" style="background:${coin.signalColor}; color:white">${coin.signal}</span></td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
        }

        // 3. Start Dynamic WebSocket
        function startMultiAssetSocket(coins) {
            if (socket) return; // Don't start twice

            // A. Filter out stablecoins & build stream string
            const streams = coins
                .filter(c => !IGNORED_COINS.includes(c.rawSymbol)) // Remove USDT, USDC etc
                .map(c => `${c.rawSymbol}usdt@trade`) // format: btcusdt@trade
                .join('/');

            // B. Connect to Binance Multiplex Stream
            const wsUrl = `wss://stream.binance.com:9443/stream?streams=${streams}`;
            console.log("Connecting to:", wsUrl);
            
            socket = new WebSocket(wsUrl);
            const feedBox = document.getElementById('whaleFeed');
            feedBox.innerHTML = ""; // Clear "Initializing" text

            socket.onopen = () => {
                const note = document.createElement('div');
                note.style.cssText = "text-align:center; padding:10px; color:#2ea043; font-size:12px;";
                note.innerText = `Connected to ${streams.split('/').length} Top Assets`;
                feedBox.appendChild(note);
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                const data = msg.data; // The actual trade data is inside .data
                
                const price = parseFloat(data.p);
                const quantity = parseFloat(data.q);
                const totalUsd = price * quantity;

                // FILTER: Only Whales
                if (totalUsd > WHALE_THRESHOLD) {
                    const symbol = data.s.replace('USDT', ''); // Clean name
                    const isSell = data.m; // data.m = true means Maker was Buyer (so Taker was Seller)
                    const type = isSell ? 'SELL' : 'BUY';
                    const colorClass = type === 'BUY' ? 'feed-buy' : 'feed-sell';
                    const icon = type === 'BUY' ? 'üü¢' : 'üî¥';

                    const item = document.createElement('div');
                    item.className = `feed-item ${colorClass}`;
                    item.innerHTML = `
                        <div>
                            <div class="whale-amt">${icon} ${symbol} ${type}</div>
                            <div class="whale-sub">Price: $${price.toLocaleString()}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="whale-amt">$${Math.floor(totalUsd).toLocaleString()}</div>
                            <div class="whale-sub">${quantity.toFixed(2)} Coins</div>
                        </div>
                    `;

                    feedBox.prepend(item);
                    
                    // Limit feed history
                    if (feedBox.children.length > 50) {
                        feedBox.removeChild(feedBox.lastChild);
                    }
                }
            };
        }

        function filterTable(t) { currentFilter = t; renderTable(); }

        // Start everything
        initApp();

        // Refresh market data (table) every 60s (Socket stays open)
        setInterval(() => {
            // We only refresh the table data, we don't reconnect socket to avoid lag
            fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=25&page=1&sparkline=false')
                .then(res => res.json())
                .then(data => {
                    // Update prices without breaking socket
                    marketData.forEach(oldCoin => {
                        const newCoin = data.find(c => c.symbol.toUpperCase() === oldCoin.symbol);
                        if(newCoin) {
                            oldCoin.price = newCoin.current_price;
                            oldCoin.change = newCoin.price_change_percentage_24h;
                        }
                    });
                    renderTable();
                });
        }, 60000);

    </script>
</body>
</html>